<div class="page-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <div>
        <h1>Gestión de Backups</h1>
        <p>Administra los respaldos y recuperación de datos del sistema</p>
      </div>
      <div class="header-buttons">
        <button
          (click)="refrescar()"
          class="btn btn-secondary">
          <span>Recargar</span>
        </button>
        <button
          (click)="openModal()"
          class="btn btn-primary">
          <span>Nuevo Backup</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs-container">
    <button 
      (click)="showPendientesModal = false"
      [class.active]="!showPendientesModal"
      class="tab-btn">
      Todos los Backups
    </button>
    <button 
      (click)="showPendientesModal = true"
      [class.active]="showPendientesModal"
      class="tab-btn">
      Backups Pendientes ({{ backupsPendientes.length }})
    </button>
  </div>

  <!-- Backups Pendientes -->
  @if (showPendientesModal) {
    <div class="content-section">
      <div class="pending-grid">
        @for (pendiente of backupsPendientes; track pendiente.id_reporte_backup) {
          <div class="pending-card">
            <div class="pending-header">
              <h3>{{ pendiente.nombre_recurso }}</h3>
              <button
                (click)="verDetallesPendientes(pendiente.id_reporte_backup)"
                class="btn btn-small btn-primary">
                <span>Ver</span>
              </button>
            </div>
            <div class="pending-body">
              <p><strong>Destino:</strong> {{ pendiente.destino }}</p>
              <p><strong>Periodicidad:</strong> {{ pendiente.periodicidad }}</p>
              <p><strong>Último:</strong> {{ pendiente.ultimo_backup }}</p>
              <span class="pending-badge">{{ pendiente.faltantes.length }} días pendientes</span>
            </div>
          </div>
        }
        @if (backupsPendientes.length === 0) {
          <div class="empty-state">
            No hay backups pendientes. ¡Todos están al día!
          </div>
        }
      </div>
    </div>
  }

  <!-- Tabla de Backups -->
  @if (!showPendientesModal) {
    <div class="content-section">
      @if (loading) {
        <div class="loading-state">
          Cargando backups...
        </div>
      }
      
      @if (!loading && backups.length > 0) {
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>Recurso</th>
                <th>Tipo</th>
                <th>Medio</th>
                <th>Periodicidad</th>
                <th>Última Fecha</th>
                <th>Tamaño</th>
                <th>Autor</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              @for (backup of backups; track backup.id_reporte_backup) {
                <tr>
                  <td class="font-medium">{{ backup.nombre_recurso }}</td>
                  <td>{{ backup.tipo_recurso }}</td>
                  <td class="text-center">{{ getMedioIcon(backup.medio || '') }} {{ backup.medio }}</td>
                  <td class="font-semibold" [class]="getPeriodicidadColor(backup.periodicidad || '')">
                    {{ backup.periodicidad }}
                  </td>
                  <td>
                    {{ backup.fecha_backup ? (backup.fecha_backup | date: 'dd/MM/yyyy HH:mm') : 'Sin fecha' }}
                  </td>
                  <td>{{ backup.tamano || 'N/A' }}</td>
                  <td>{{ getNombreUsuario(backup.id_autor_realizado_fk) }}</td>
                  <td class="actions-cell">
                    <div class="action-buttons">
                      <button
                        (click)="openModal(backup)"
                        class="btn btn-icon"
                        title="Editar">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button
                        (click)="deleteBackup(backup.id_reporte_backup)"
                        class="btn btn-icon"
                        title="Eliminar">
                        <i class="fas fa-trash"></i>
                      </button>
                      <button
                        (click)="actualizarBackupRealizado(backup)"
                        class="btn btn-icon"
                        title="Marcar como realizado">
                        <i class="fas fa-check"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }

      @if (!loading && backups.length === 0) {
        <div class="empty-state">
          No hay registros de backups. ¡Crea uno!
        </div>
      }
    </div>
  }

  <!-- Modal -->
  @if (showModal) {
    <div class="modal-overlay">
      <div class="modal-container">
        <!-- Header -->
        <div class="modal-header">
          <h2>{{ isEditMode ? 'Editar Backup' : 'Nuevo Backup' }}</h2>
          <button class="btn-close" (click)="closeModal()" type="button">✕</button>
        </div>

        <!-- Body -->
        <div class="modal-body">
          <form (ngSubmit)="saveBackup()">
            <!-- Información del Backup -->
            <div class="form-section">
              <h3 class="section-title">Información del Backup</h3>

              <div class="form-row">
                <div class="form-group">
                  <label for="nombre_recurso">Nombre del Recurso <span class="required">*</span></label>
                  <input
                    type="text"
                    id="nombre_recurso"
                    [(ngModel)]="currentBackup!.nombre_recurso"
                    name="nombre_recurso"
                    required
                    placeholder="Ej: Base de datos principal"
                  />
                </div>

                <div class="form-group">
                  <label for="tipo_recurso">Tipo de Recurso <span class="required">*</span></label>
                  <select
                    id="tipo_recurso"
                    [(ngModel)]="currentBackup!.tipo_recurso"
                    name="tipo_recurso"
                    required
                  >
                    <option value="">-- Seleccionar --</option>
                    <option *ngFor="let tipo of tiposRecurso" [value]="tipo">{{ tipo }}</option>
                  </select>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="medio">Medio <span class="required">*</span></label>
                  <select
                    id="medio"
                    [(ngModel)]="currentBackup!.medio"
                    name="medio"
                    required
                  >
                    <option value="">-- Seleccionar --</option>
                    <option *ngFor="let medio of medios" [value]="medio">{{ medio }}</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="periodicidad">Periodicidad <span class="required">*</span></label>
                  <select
                    id="periodicidad"
                    [(ngModel)]="currentBackup!.periodicidad"
                    name="periodicidad"
                    required
                  >
                    <option value="">-- Seleccionar --</option>
                    <option *ngFor="let per of periodicidades" [value]="per">{{ per }}</option>
                  </select>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="destino">Destino</label>
                  <input
                    type="text"
                    id="destino"
                    [(ngModel)]="currentBackup!.destino"
                    name="destino"
                    placeholder="Ej: /backups/bd"
                  />
                </div>

                <div class="form-group">
                  <label for="tamano">Tamaño</label>
                  <input
                    type="text"
                    id="tamano"
                    [(ngModel)]="currentBackup!.tamano"
                    name="tamano"
                    placeholder="Ej: 250 GB"
                  />
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="fecha_backup">Fecha del Backup</label>
                  <input
                    type="datetime-local"
                    id="fecha_backup"
                    [(ngModel)]="currentBackup!.fecha_backup"
                    name="fecha_backup"
                  />
                </div>

                <div class="form-group">
                  <label for="usuario_realizo">Usuario que Realizó</label>
                  <select
                    id="usuario_realizo"
                    [(ngModel)]="currentBackup!.id_autor_realizado_fk"
                    name="id_autor_realizado_fk"
                  >
                    <option [value]="null">-- Seleccionar --</option>
                    <option *ngFor="let usuario of usuarios" [value]="usuario.id">
                      {{ usuario.nombres }} {{ usuario.apellidos }}
                    </option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Información Adicional -->
            <div class="form-section">
              <h3 class="section-title">Información Adicional</h3>

              <div class="form-row">
                <div class="form-group">
                  <label for="autor_solicita">Autor que Solicita</label>
                  <input
                    type="text"
                    id="autor_solicita"
                    [(ngModel)]="currentBackup!.autor_solicita"
                    name="autor_solicita"
                    placeholder="Nombre del solicitante"
                  />
                </div>

                <div class="form-group">
                  <label for="numero_caso_ms">Número de Caso MS</label>
                  <input
                    type="text"
                    id="numero_caso_ms"
                    [(ngModel)]="currentBackup!.numero_caso_ms"
                    name="numero_caso_ms"
                    placeholder="Ej: MS-123456"
                  />
                </div>
              </div>

              <div class="form-row full-width">
                <div class="form-group">
                  <label for="observaciones">Observaciones</label>
                  <textarea
                    id="observaciones"
                    [(ngModel)]="currentBackup!.observaciones"
                    name="observaciones"
                    rows="4"
                    placeholder="Notas adicionales sobre este backup..."
                  ></textarea>
                </div>
              </div>
            </div>

            <!-- Footer -->
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" (click)="closeModal()">
                <span>Cancelar</span>
              </button>
              <button type="submit" class="btn btn-primary">
                <span>{{ isEditMode ? 'Actualizar' : 'Guardar' }}</span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  }

</div>
