<div class="container">
  <div class="page-header">
    <div>
      <h1>Gestión de Equipos</h1>
      <p class="subtitle">Administra todos los equipos de sistemas del hospital</p>
    </div>
    <div class="header-actions">
      <button class="btn btn-primary" (click)="openCreateModal()">
        <span></span>
        <span>+ Nuevo Equipo</span>
      </button>
    </div>
  </div>

  <!-- Filtros de vista -->
  <div class="view-filters">
    <button
      class="view-filter-btn"
      [class.active]="selectedView === 'all'"
      (click)="changeView('all')"
      [disabled]="isLoading">
      <i class="fas fa-list"></i>
      <span>Todos los Equipos</span>
      <span class="badge-count" *ngIf="totalEquipos > 0">{{ totalEquipos }}</span>
    </button>
    <button
      class="view-filter-btn"
      [class.active]="selectedView === 'bodega'"
      (click)="changeView('bodega')"
      [disabled]="isLoading">
      <i class="fas fa-warehouse"></i>
      <span>En Bodega</span>
      <span class="badge-count" *ngIf="totalBodega > 0">{{ totalBodega }}</span>
    </button>
    <button
      class="view-filter-btn"
      [class.active]="selectedView === 'baja'"
      (click)="changeView('baja')"
      [disabled]="isLoading">
      <i class="fas fa-ban"></i>
      <span>Dados de Baja</span>
      <span class="badge-count" *ngIf="totalBaja > 0">{{ totalBaja }}</span>
    </button>
  </div>

  <!-- Barra de búsqueda y filtros -->
  <div class="toolbar">
    <div class="search-box">
      <span class="search-icon"><i class="fas fa-search"></i></span>
      <input
        type="text"
        name="equipment-search"
        autocomplete="off"
        placeholder="Buscar por nombre, marca, modelo o ubicación..."
        (input)="onSearch($event)"
        [disabled]="isLoading"
      />
    </div>
    <div class="filters">
      <select class="filter-select" (change)="onEstadoChange($event)" [disabled]="isLoading">
        <option value="">Todos los estados</option>
        <option value="1">Activos</option>
        <option value="0">Inactivos</option>
      </select>
    </div>
  </div>

  <!-- Mensaje de carga -->
  @if (isLoading) {
    <div class="loading-state">
      <div class="spinner">⏳</div>
      <p>Cargando equipos...</p>
    </div>
  }

  <!-- Mensaje de error -->
  @if (error && !isLoading) {
    <div class="error-state">
      <div class="error-icon"><i class="fas fa-exclamation-triangle"></i></div>
      <p>{{ error }}</p>
      <button class="btn btn-primary" (click)="loadEquipos()">Reintentar</button>
    </div>
  }

  <!-- Tabla de equipos -->
  @if (!isLoading && !error) {
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Marca</th>
            <th>Modelo</th>
            <th>Serie</th>
            <th>Ubicación</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          @for (equipo of filteredEquipos; track equipo.id_sysequipo) {
            <tr>
              <td>{{ equipo.id_sysequipo }}</td>
              <td><strong>{{ equipo.nombre_equipo }}</strong></td>
              <td>{{ equipo.marca || 'N/A' }}</td>
              <td>{{ equipo.modelo || 'N/A' }}</td>
              <td><code class="serie-badge">{{ formatSerie(equipo.serie) }}</code></td>
              <td>{{ equipo.ubicacion || 'N/A' }}</td>
              <td>
                <span [class]="getEstadoBadgeClass(equipo.activo)">
                  {{ formatEstado(equipo.activo) }}
                </span>
              </td>
              <td>
                <div class="action-buttons">
                  <!-- Botón Ver - Siempre visible -->
                  <button class="btn btn-icon" title="Ver detalles" (click)="openDetailModal(equipo)"><i class="fas fa-eye"></i></button>

                  <!-- Botones para vista de Bodega -->
                  @if (selectedView === 'bodega') {
                    <button class="btn btn-icon btn-success" title="Reactivar equipo y asignar ubicación" (click)="reactivarEquipo(equipo)"><i class="fas fa-power-off"></i></button>
                    <button class="btn btn-icon btn-danger" title="Eliminar" (click)="confirmDelete(equipo)"><i class="fas fa-trash"></i></button>
                  }

                  <!-- Botones para vista Normal (Todos los equipos) -->
                  @if (selectedView === 'all') {
                    <button class="btn btn-icon" title="Editar" (click)="openEditModal(equipo)"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-icon" title="Eliminar" (click)="confirmDelete(equipo)"><i class="fas fa-trash"></i></button>
                  }

                  <!-- Vista de Dados de Baja: solo Ver (sin otros botones) -->
                </div>
              </td>
            </tr>
          } @empty {
            <tr>
              <td colspan="8" class="empty-state">
                <div class="empty-icon"><i class="fas fa-boxes"></i></div>
                <p>No se encontraron equipos</p>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }

  <!-- Paginación (placeholder) -->
  <div class="pagination">
    <button class="btn btn-secondary">Anterior</button>
    <span class="page-info">Página 1 de 1</span>
    <button class="btn btn-secondary">Siguiente</button>
  </div>
</div>

<!-- Modal de Equipo (Crear/Editar) -->
<app-equipo-modal
  [isOpen]="isModalOpen"
  [equipo]="selectedEquipo"
  (closed)="closeModal()"
  (saved)="onEquipoSaved()"
></app-equipo-modal>

<!-- Modal de Confirmación de Eliminación -->
<app-delete-confirmation-dialog
  [isOpen]="isDeleteOptionsDialogOpen"
  [itemName]="equipoToDeleteWithOptions?.nombre_equipo || ''"
  [itemType]="'equipo'"
  [isAdmin]="isAdmin"
  [hideBodegaOption]="selectedView === 'bodega'"
  (closed)="closeDeleteOptionsDialog()"
  (confirmed)="handleDeleteOptionsConfirm($event)"
></app-delete-confirmation-dialog>

<!-- Modal de Vista Detallada -->
<app-equipo-detail-modal
  [isOpen]="isDetailModalOpen"
  [equipo]="equipoToView"
  (closed)="closeDetailModal()"
  (editRequested)="onEditFromDetail($event)"
></app-equipo-detail-modal>

<!-- Modal de Reactivar Equipo -->
<app-reactivar-equipo-modal
  [isOpen]="isReactivarModalOpen"
  [equipoNombre]="equipoToReactivar?.nombre_equipo || ''"
  [ubicacionAnterior]="equipoToReactivar?.ubicacion_anterior || ''"
  (closed)="closeReactivarModal()"
  (confirmed)="handleReactivarConfirm($event)"
></app-reactivar-equipo-modal>
